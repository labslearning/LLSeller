{% extends "unfold/layouts/base.html" %}
{% load i18n unfold static %}

{% block content %}
<main class="min-h-screen p-6 lg:p-12 font-sans antialiased text-slate-900 bg-slate-50 dark:bg-[#0a0a0a] dark:text-slate-200 transition-colors duration-300">

    <header class="max-w-[1600px] mx-auto mb-12 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 pb-8 border-b border-slate-200 dark:border-slate-800/60">
        <div>
            <div class="flex items-center gap-4 mb-3">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-slate-900 dark:bg-white">
                    <span class="text-white material-symbols-outlined dark:text-slate-900 text-base">terminal</span>
                </div>
                <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">
                    Sovereign <span class="text-slate-500 font-normal">Engine</span>
                </h1>
                <span class="px-2.5 py-1 text-xs font-semibold tracking-wide text-blue-700 bg-blue-100 rounded-md dark:bg-blue-900/30 dark:text-blue-400 border border-blue-200 dark:border-blue-800/50">
                    CORE V4.1.0
                </span>
            </div>
            <p class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400 font-mono">
                <span class="relative flex h-2.5 w-2.5">
                    <span class="absolute inline-flex w-full h-full rounded-full opacity-75 animate-ping bg-emerald-500"></span>
                    <span class="relative inline-flex w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                </span>
                Distributed Intelligence Network &bull; <span id="sys-clock" class="text-slate-700 dark:text-slate-300">Initializing...</span>
            </p>
        </div>

        <div class="flex flex-wrap items-center gap-4">
            <div class="px-5 py-3 transition-shadow bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md dark:bg-[#111111] dark:border-slate-800">
                <p class="mb-1 text-xs font-semibold text-slate-500 uppercase tracking-wider">Avg Lead Potential</p>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-semibold font-mono text-slate-900 dark:text-white">{{ avg_score|default:"0.0"|floatformat:1 }}</span>
                    <span class="text-emerald-500 material-symbols-outlined text-sm">trending_up</span>
                </div>
            </div>
            <div class="px-5 py-3 transition-shadow bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md dark:bg-[#111111] dark:border-slate-800 border-l-4 border-l-blue-600">
                <p class="mb-1 text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Pipeline</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-semibold font-mono text-blue-600 dark:text-blue-400">{{ total_leads }}</span>
                    <span class="text-xs font-medium text-slate-400 uppercase tracking-wide">Entities</span>
                </div>
            </div>
        </div>
    </header>

    <section class="max-w-[1600px] mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 animate-fade-in-up">
        
        <article class="p-6 bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-[#111111] dark:border-slate-800">
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
                        <span class="material-symbols-outlined">biotech</span>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Phase 01</p>
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Raw Discovery</h3>
                    </div>
                </div>
            </header>
            <div class="mb-6">
                <p class="text-sm font-medium text-slate-500 mb-1">Leads Ciegos</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-bold tracking-tight text-slate-900 dark:text-white">{{ blind_leads }}</span>
                    <span class="text-sm font-medium text-slate-400">/ {{ total_leads }}</span>
                </div>
            </div>
            <div>
                <div class="flex justify-between mb-2 text-xs font-medium text-slate-600 dark:text-slate-400">
                    <span>Penetration</span>
                    <span class="font-mono">{{ p_blind }}%</span>
                </div>
                <div class="w-full h-2 overflow-hidden bg-slate-100 rounded-full dark:bg-slate-800">
                    <div class="h-full transition-all duration-1000 bg-slate-900 dark:bg-white" style="width: {{ p_blind }}%"></div>
                </div>
            </div>
        </article>

        <article class="p-6 bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-[#111111] dark:border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-50 text-blue-600 dark:bg-blue-500/10 dark:text-blue-400">
                        <span class="material-symbols-outlined">satellite_alt</span>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">Phase 02</p>
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">DNS Resolution</h3>
                    </div>
                </div>
            </header>
            <div class="mb-6">
                <p class="text-sm font-medium text-slate-500 mb-1">Pendientes Scan</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-bold tracking-tight text-slate-900 dark:text-white">{{ ready_to_scan }}</span>
                    <span class="text-sm font-medium text-slate-400">Targets</span>
                </div>
            </div>
            <div>
                <div class="flex justify-between mb-2 text-xs font-medium text-slate-600 dark:text-slate-400">
                    <span>Readiness</span>
                    <span class="font-mono text-blue-600 dark:text-blue-400">{{ p_ready }}%</span>
                </div>
                <div class="w-full h-2 overflow-hidden bg-slate-100 rounded-full dark:bg-slate-800">
                    <div class="h-full transition-all duration-1000 bg-blue-500" style="width: {{ p_ready }}%"></div>
                </div>
            </div>
        </article>

        <article class="p-6 bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-[#111111] dark:border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-50 text-emerald-600 dark:bg-emerald-500/10 dark:text-emerald-400">
                        <span class="material-symbols-outlined">psychology</span>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Phase 03</p>
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Enriched Data</h3>
                    </div>
                </div>
            </header>
            <div class="mb-6">
                <p class="text-sm font-medium text-slate-500 mb-1">Enriquecidos</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-bold tracking-tight text-slate-900 dark:text-white">{{ enriched_leads }}</span>
                    <span class="text-sm font-medium text-slate-400">Valid Leads</span>
                </div>
            </div>
            <div>
                <div class="flex justify-between mb-2 text-xs font-medium text-slate-600 dark:text-slate-400">
                    <span>Deployment Coverage</span>
                    <span class="font-mono text-emerald-600 dark:text-emerald-400">{{ p_enriched }}%</span>
                </div>
                <div class="w-full h-2 overflow-hidden bg-slate-100 rounded-full dark:bg-slate-800">
                    <div class="h-full transition-all duration-1000 bg-emerald-500" style="width: {{ p_enriched }}%"></div>
                </div>
            </div>
        </article>
    </section>

    <section class="max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 items-stretch engine-panels">
        
        <article class="flex flex-col bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-[#111111] dark:border-slate-800">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800/60">
                <h2 class="flex items-center gap-2 mb-2 text-lg font-semibold text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined text-slate-400">explore</span> OSM Radar
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Inyección geolocalizada de leads. Extrae nombres y coordenadas vía satélite.</p>
            </div>
            <form method="POST" class="flex flex-col flex-1 p-6 space-y-6" onsubmit="return UXController.handleDeployment(this, 'RADAR BARRAGE')">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="radar">
                
                <div class="space-y-4 flex-1">
                    <div>
                        <label for="country" class="block mb-1.5 text-xs font-semibold text-slate-700 dark:text-slate-300">Target Territory</label>
                        <input type="text" id="country" name="country" value="España" required 
                               class="w-full px-4 py-2.5 text-sm bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 dark:bg-[#0a0a0a] dark:border-slate-700 dark:text-white transition-shadow">
                    </div>
                    <div>
                        <label for="city" class="block mb-1.5 text-xs font-semibold text-slate-700 dark:text-slate-300">Operational Area</label>
                        <input type="text" id="city" name="city" value="Madrid" required 
                               class="w-full px-4 py-2.5 text-sm bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 dark:bg-[#0a0a0a] dark:border-slate-700 dark:text-white transition-shadow">
                    </div>
                </div>
                
                <button type="submit" class="flex items-center justify-center w-full gap-2 px-4 py-3 text-sm font-semibold text-white transition-colors rounded-lg bg-slate-900 hover:bg-slate-800 dark:bg-white dark:text-slate-900 dark:hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-900 dark:focus:ring-offset-[#111111]">
                    Launch Scanning <span class="material-symbols-outlined text-sm">arrow_forward</span>
                </button>
            </form>
        </article>

        <article class="flex flex-col bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-[#111111] dark:border-slate-800 relative overflow-hidden">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800/60 bg-blue-50/30 dark:bg-blue-500/5">
                <h2 class="flex items-center gap-2 mb-2 text-lg font-semibold text-blue-700 dark:text-blue-400">
                    <span class="material-symbols-outlined">language</span> SERP Tracker
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Conversión heurística de nombres a URLs reales mediante clústers de búsqueda.</p>
            </div>
            <form method="POST" class="flex flex-col flex-1 p-6 space-y-6" onsubmit="return UXController.handleDeployment(this, 'SERP CLUSTER EXECUTION')">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="serp">
                
                <fieldset class="flex-1">
                    <legend class="block mb-3 text-xs font-semibold text-slate-700 dark:text-slate-300">Infiltration Batch Size</legend>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative flex flex-col items-start p-4 cursor-pointer border border-slate-200 rounded-xl hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800/50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-500/10 has-[:checked]:ring-1 has-[:checked]:ring-blue-500">
                            <input type="radio" name="limit" value="50" checked class="sr-only peer">
                            <span class="text-lg font-bold text-slate-900 dark:text-white">50</span>
                            <span class="text-xs font-medium text-slate-500">Precision Mode</span>
                        </label>
                        <label class="relative flex flex-col items-start p-4 cursor-pointer border border-slate-200 rounded-xl hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800/50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-500/10 has-[:checked]:ring-1 has-[:checked]:ring-blue-500">
                            <input type="radio" name="limit" value="200" class="sr-only peer">
                            <span class="text-lg font-bold text-slate-900 dark:text-white">200</span>
                            <span class="text-xs font-medium text-slate-500">Balanced Mode</span>
                        </label>
                    </div>
                </fieldset>
                
                <button type="submit" class="flex items-center justify-center w-full gap-2 px-4 py-3 text-sm font-semibold text-white transition-colors bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 dark:focus:ring-offset-[#111111]">
                    Execute Resolver <span class="material-symbols-outlined text-sm">search</span>
                </button>
            </form>
        </article>

        <article class="flex flex-col bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-[#111111] dark:border-slate-800">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800/60 bg-violet-50/30 dark:bg-violet-500/5">
                <h2 class="flex items-center gap-2 mb-2 text-lg font-semibold text-violet-700 dark:text-violet-400">
                    <span class="material-symbols-outlined">radar</span> Ghost Sniper
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Extracción forense profunda. Captura el stack tecnológico, LMS y correos del Rector.</p>
            </div>
            <form method="POST" class="flex flex-col flex-1 p-6 space-y-6" onsubmit="return UXController.handleDeployment(this, 'DEPLOYING STEALTH BOT')">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="sniper">
                
                <div class="flex-1 space-y-4">
                    <div>
                        <label for="sniper_limit" class="block mb-1.5 text-xs font-semibold text-slate-700 dark:text-slate-300">Payload Intensity</label>
                        <select id="sniper_limit" name="limit" class="w-full px-4 py-2.5 text-sm bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500/20 focus:border-violet-500 dark:bg-[#0a0a0a] dark:border-slate-700 dark:text-white transition-shadow appearance-none cursor-pointer">
                            <option value="10">Targeted (10 Targets)</option>
                            <option value="30" selected>Standard Aggressive (30 Targets)</option>
                            <option value="100">C-Suite Massive (100 Targets)</option>
                        </select>
                    </div>
                    
                    <div class="flex items-start gap-2 p-3 rounded-lg bg-slate-50 border border-slate-200 dark:bg-slate-800/50 dark:border-slate-700/50">
                        <span class="material-symbols-outlined text-slate-400 text-sm mt-0.5">shield</span>
                        <p class="text-xs font-medium text-slate-600 dark:text-slate-400 leading-relaxed">
                            Bypassing: Cloudflare, Akamai, Datadome. Routing via Resident Proxy Cluster.
                        </p>
                    </div>
                </div>
                
                <button type="submit" class="flex items-center justify-center w-full gap-2 px-4 py-3 text-sm font-semibold text-white transition-colors bg-violet-600 rounded-lg hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-600 dark:focus:ring-offset-[#111111]">
                    Engage Infiltration <span class="material-symbols-outlined text-sm">bolt</span>
                </button>
            </form>
        </article>

    </section>

    <script>
        const UXController = {
            init: () => {
                UXController.startClock();
                UXController.animatePanels();
            },

            startClock: () => {
                const clockEl = document.getElementById('sys-clock');
                if (!clockEl) return;
                
                setInterval(() => {
                    const now = new Date();
                    clockEl.textContent = `UTC ${now.toLocaleTimeString('en-US', { hour12: false })}`;
                }, 1000);
            },

            animatePanels: () => {
                const panels = document.querySelectorAll('.engine-panels > article');
                panels.forEach((panel, index) => {
                    panel.style.opacity = '0';
                    panel.style.transform = 'translateY(15px)';
                    setTimeout(() => {
                        panel.style.transition = 'all 0.5s ease-out';
                        panel.style.opacity = '1';
                        panel.style.transform = 'translateY(0)';
                    }, 50 * index);
                });
            },

            handleDeployment: (form, missionName) => {
                const btn = form.querySelector('button[type="submit"]');
                if(!btn) return true;

                // Disable button cleanly
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-wait');
                btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-sm">sync</span> Processing...`;
                
                UXController.showToast(missionName);
                return true; // Permitir submit
            },

            showToast: (missionName) => {
                // Eliminar toast anterior si existe
                const existingToast = document.getElementById('sys-toast');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.id = 'sys-toast';
                toast.className = 'fixed bottom-6 right-6 flex items-center gap-4 px-5 py-4 bg-slate-900 text-white rounded-xl shadow-xl z-50 animate-slide-up border border-slate-700';
                
                toast.innerHTML = `
                    <span class="relative flex h-3 w-3">
                        <span class="absolute inline-flex w-full h-full rounded-full opacity-75 animate-ping bg-blue-400"></span>
                        <span class="relative inline-flex w-3 h-3 rounded-full bg-blue-500"></span>
                    </span>
                    <div>
                        <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Executing Protocol</p>
                        <p class="text-sm font-semibold">${missionName}</p>
                    </div>
                `;
                
                document.body.appendChild(toast);
            }
        };

        document.addEventListener('DOMContentLoaded', UXController.init);
    </script>

    <style>
        /* Tipografía Limpia (Adiós tracking negativo extremo) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root { 
            font-family: 'Inter', system-ui, sans-serif; 
        }
        
        /* Animaciones Sutiles y fluidas */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
        
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Reseteo para inputs escondidos pero accesibles (Radio Buttons) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Scrollbar Discreto */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar-thumb { background: #333333; }
            ::-webkit-scrollbar-thumb:hover { background: #444444; }
        }
    </style>
</main>
{% endblock %}