{% extends "unfold/layouts/base.html" %}
{% load i18n unfold static %}

{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<main class="min-h-screen bg-[#000000] font-sans antialiased text-slate-300 p-2 lg:p-4 selection:bg-red-600/50 selection:text-white overflow-hidden relative"
      x-data="ghostSwarmTerminal()" 
      x-init="initializeSystem()">

    <div class="pointer-events-none fixed inset-0 z-[100] bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.4)_50%),linear-gradient(90deg,rgba(255,0,0,0.03),rgba(0,255,0,0.01),rgba(0,0,255,0.03))] bg-[length:100%_4px,3px_100%] opacity-40 mix-blend-overlay"></div>
    <div class="pointer-events-none fixed inset-0 z-[90] shadow-[inset_0_0_300px_rgba(0,0,0,0.99)]"></div>
    
    <div class="fixed inset-0 z-0 pointer-events-none opacity-[0.25] bg-grid-tactical" 
         style="background-image: linear-gradient(rgba(220,38,38,0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(220,38,38,0.15) 1px, transparent 1px); background-size: 40px 40px;">
        <div class="absolute inset-0 bg-gradient-to-b from-[#000000] via-transparent to-[#000000] opacity-90"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-[#000000] via-transparent to-[#000000] opacity-90"></div>
    </div>
    
    <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[1800px] h-[1200px] rounded-[100%] blur-[250px] pointer-events-none z-0 transition-all duration-1000 ease-in-out"
         :class="isScanning ? 'bg-red-900/50 scale-[1.3] animate-pulse' : (isComplete ? 'bg-emerald-900/30 scale-[1.1]' : 'bg-red-950/10 scale-100')"></div>

    <div class="relative z-10 max-w-[2000px] mx-auto grid grid-cols-1 xl:grid-cols-12 gap-5 h-[calc(100vh-2rem)]">

        <aside class="hidden xl:flex flex-col col-span-3 h-full border border-red-900/50 bg-[#030303]/80 backdrop-blur-3xl rounded-xl p-5 shadow-[0_0_60px_rgba(220,38,38,0.06)] relative overflow-hidden panel-clip">
            
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-90 animate-scanline-h"></div>
            
            <div class="border-b border-red-900/50 pb-5 mb-5 flex items-center gap-4 relative">
                <div class="w-14 h-14 bg-black border border-red-500/50 flex items-center justify-center relative overflow-hidden hexagon-clip shadow-[0_0_20px_rgba(220,38,38,0.5)] group">
                    <div class="absolute inset-0 bg-red-600/30 animate-pulse group-hover:bg-red-500/50 transition-colors"></div>
                    <div class="absolute top-0 left-0 w-full h-[2px] bg-white opacity-60 animate-scanline-v"></div>
                    <span class="material-symbols-outlined text-white text-2xl relative z-10 drop-shadow-[0_0_5px_white]">hub</span>
                </div>
                <div>
                    <h2 class="text-white font-black uppercase tracking-[0.3em] text-[13px] glitch-text" data-text="LEVIATHAN_CORE">LEVIATHAN_CORE</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-1.5 h-1.5 rounded-full" :class="isScanning ? 'bg-red-500 animate-ping' : 'bg-emerald-500'"></span>
                        <p class="text-red-400 font-mono text-[10px] uppercase tracking-[0.4em] drop-shadow-[0_0_5px_red]" x-text="sysTime"></p>
                    </div>
                </div>
            </div>

            <div class="space-y-4 mb-4 flex-1">
                <h3 class="text-slate-400 font-mono text-[9px] font-black uppercase tracking-[0.6em] flex items-center gap-2 border-b border-white/5 pb-2">
                    <span class="material-symbols-outlined text-[14px]">memory</span> Network_Telemetry
                </h3>
                
                <div class="bg-black/60 border border-white/5 p-3 rounded-lg relative overflow-hidden">
                    <div class="flex justify-between text-[10px] font-mono mb-1.5">
                        <span class="text-slate-500 tracking-widest">SAT_UPLINK</span>
                        <span class="font-bold drop-shadow-[0_0_5px_rgba(16,185,129,0.8)]" :class="isScanning ? 'text-red-500' : 'text-emerald-500'" x-text="metrics.uplink + ' MS'"></span>
                    </div>
                    <div class="w-full bg-slate-900 h-1 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-500 shadow-[0_0_10px_rgba(16,185,129,0.8)]" 
                             :class="isScanning ? 'bg-red-500' : 'bg-emerald-500'" :style="'width: ' + (100 - metrics.uplink/3) + '%'"></div>
                    </div>
                </div>

                <div class="bg-black/60 border border-white/5 p-3 rounded-lg relative overflow-hidden">
                    <div class="flex justify-between text-[10px] font-mono mb-1.5">
                        <span class="text-slate-500 tracking-widest">DRONES_CELERY</span>
                        <span class="text-purple-400 font-bold drop-shadow-[0_0_5px_rgba(168,85,247,0.8)]" x-text="metrics.nodes + '/256'"></span>
                    </div>
                    <div class="w-full bg-slate-900 h-1 rounded-full overflow-hidden">
                        <div class="bg-purple-500 h-full transition-all duration-300" :style="'width: ' + (metrics.nodes/256)*100 + '%'"></div>
                    </div>
                </div>

                <div class="bg-black/60 border border-white/5 p-3 rounded-lg relative overflow-hidden">
                    <div class="flex justify-between text-[10px] font-mono mb-1.5">
                        <span class="text-slate-500 tracking-widest">DNS_PRE_RECON</span>
                        <span class="text-blue-400 font-bold drop-shadow-[0_0_5px_rgba(59,130,246,0.8)]" x-text="metrics.dns_queries + ' RQ'"></span>
                    </div>
                    <div class="w-full bg-slate-900 h-1 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full transition-all duration-300 animate-pulse" :style="'width: ' + (metrics.dns_queries > 0 ? '100%' : '0%')"></div>
                    </div>
                </div>
            </div>

            <div class="h-[350px] border border-red-900/50 bg-[#000000] rounded-lg p-4 overflow-hidden relative font-mono text-[9px] uppercase leading-relaxed shadow-[inset_0_0_30px_rgba(0,0,0,1)]">
                <div class="absolute top-0 left-0 w-full h-10 bg-gradient-to-b from-[#000000] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full h-10 bg-gradient-to-t from-[#000000] to-transparent z-10 pointer-events-none"></div>
                
                <h4 class="text-white/40 border-b border-red-900/30 pb-2 mb-2 tracking-[0.4em] flex justify-between font-bold items-center">
                    <span>Interceptor_Log</span>
                    <span class="material-symbols-outlined text-[12px]" :class="isScanning || metrics.dns_queries > 0 ? 'text-red-500 animate-[spin_1s_linear_infinite]' : 'text-slate-600'">autorenew</span>
                </h4>
                
                <div class="space-y-1.5 flex flex-col-reverse h-[calc(100%-2rem)] overflow-y-auto custom-scrollbar pb-4" id="intercept-log">
                    <template x-for="(log, index) in logs" :key="index">
                        <p x-html="log" class="animate-in slide-in-from-left-4 fade-in duration-200"></p>
                    </template>
                </div>
            </div>
        </aside>

        <div class="col-span-1 xl:col-span-9 flex flex-col h-full gap-5">
            
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b border-red-900/30 pb-4 gap-4">
                <div class="flex items-center gap-5">
                    <div class="relative w-16 h-16 bg-black border-2 flex items-center justify-center group overflow-hidden transition-colors duration-500 cyber-clip"
                         :class="isComplete ? 'border-emerald-600 shadow-[0_0_30px_rgba(16,185,129,0.5)]' : 'border-red-600 shadow-[0_0_30px_rgba(220,38,38,0.5)]'">
                        <div class="absolute inset-0 transition-colors animate-pulse z-0"
                             :class="isComplete ? 'bg-emerald-600/20' : 'bg-red-600/20'"></div>
                        <div class="absolute w-[200%] h-1 bg-white/30 -rotate-45 transform -translate-x-full group-hover:animate-shine z-10"></div>
                        <span class="material-symbols-outlined text-4xl relative z-20"
                              :class="isComplete ? 'text-emerald-500' : 'text-white'">troubleshoot</span>
                    </div>
                    <div>
                        <h1 class="text-5xl lg:text-6xl font-black tracking-tighter text-white uppercase glitch" data-text="GHOST_SNIPER">
                            GHOST_SNIPER
                        </h1>
                        <div class="flex items-center gap-3 mt-1.5">
                            <span class="px-2 py-0.5 bg-red-900/60 border border-red-500 text-white font-mono text-[10px] tracking-[0.4em] uppercase shadow-[0_0_10px_rgba(220,38,38,0.5)] font-black">STRICT LEVEL 10</span>
                            <span class="text-slate-500 font-mono text-[10px] tracking-[0.3em] uppercase border-l border-white/20 pl-3">Weaponized OSINT Engine</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-5 font-mono text-[10px] text-slate-300 bg-black/80 px-5 py-3 rounded-lg border border-red-900/40 shadow-inner">
                    <div class="flex flex-col items-end border-r border-white/10 pr-5">
                        <span class="text-slate-600 uppercase mb-0.5 tracking-widest">Base_De_Datos</span>
                        <span class="text-blue-400 flex items-center gap-1.5 font-black tracking-[0.2em] drop-shadow-[0_0_5px_rgba(59,130,246,0.8)]">
                            <span class="material-symbols-outlined text-[12px]">cloud_done</span> POSTGRES V15
                        </span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-slate-600 uppercase mb-0.5 tracking-widest">Motor_Inteligencia</span>
                        <span class="text-emerald-400 font-black tracking-[0.2em] drop-shadow-[0_0_5px_rgba(16,185,129,0.8)] flex items-center gap-1.5">
                            DEEPSEEK AI <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span>
                        </span>
                    </div>
                </div>
            </header>

            <section class="relative z-20 animate-in fade-in zoom-in duration-500 flex-none">
                
                <form id="swarm-input-form" 
                      hx-post="/api/ghost-swarm/search/" 
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                      hx-target="#sniper-display" 
                      hx-swap="innerHTML"
                      @submit="executeAnalysis($event)"
                      class="relative bg-[#050505]/95 backdrop-blur-3xl rounded-xl flex flex-col xl:flex-row border shadow-[0_20px_50px_rgba(0,0,0,0.8)] overflow-hidden transition-colors duration-500"
                      :class="isScanning ? 'border-red-500/60 shadow-[0_0_30px_rgba(220,38,38,0.2)]' : (isComplete ? 'border-emerald-500/50 shadow-[0_0_30px_rgba(16,185,129,0.1)]' : 'border-red-900/30')">
                    
                    <div class="flex-1 flex flex-col p-4 gap-4 relative">
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 bg-[#000000] p-3 rounded-lg border border-red-900/30 shadow-inner">
                            
                            <div class="col-span-1">
                                <label class="text-[8px] text-slate-500 font-mono tracking-[0.3em] uppercase mb-1 block">Geo-Contexto: Ciudad</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-600 text-[14px]">location_on</span>
                                    <input type="text" name="context_city" placeholder="Ej: Bogotá, Madrid..." 
                                           class="w-full bg-[#0a0a0a] border border-white/5 rounded font-mono text-xs text-white py-2 pl-8 pr-2 focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-slate-700">
                                </div>
                            </div>
                            
                            <div class="col-span-1">
                                <label class="text-[8px] text-slate-500 font-mono tracking-[0.3em] uppercase mb-1 block">Geo-Contexto: País</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-600 text-[14px]">public</span>
                                    <input type="text" name="context_country" placeholder="Ej: Colombia, España..." 
                                           class="w-full bg-[#0a0a0a] border border-white/5 rounded font-mono text-xs text-white py-2 pl-8 pr-2 focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-slate-700">
                                </div>
                            </div>

                            <div class="col-span-1 flex flex-col justify-end pb-1">
                                <label class="text-[8px] text-slate-500 font-mono tracking-[0.3em] uppercase mb-1.5 block">Vectores OSINT (Activos)</label>
                                <div class="flex gap-2 flex-wrap">
                                    <input type="hidden" name="osint_lms" :value="osintModules.lms">
                                    <input type="hidden" name="osint_whatsapp" :value="osintModules.whatsapp">
                                    <input type="hidden" name="osint_email" :value="osintModules.email">
                                    
                                    <button type="button" @click="osintModules.lms = !osintModules.lms" class="px-2 py-0.5 font-mono text-[9px] border rounded transition-colors shadow-sm" :class="osintModules.lms ? 'bg-red-900/40 border-red-500/50 text-red-400' : 'bg-black border-white/10 text-slate-600'">LMS/Tech</button>
                                    <button type="button" @click="osintModules.whatsapp = !osintModules.whatsapp" class="px-2 py-0.5 font-mono text-[9px] border rounded transition-colors shadow-sm" :class="osintModules.whatsapp ? 'bg-emerald-900/40 border-emerald-500/50 text-emerald-400' : 'bg-black border-white/10 text-slate-600'">WhatsApp</button>
                                    <button type="button" @click="osintModules.email = !osintModules.email" class="px-2 py-0.5 font-mono text-[9px] border rounded transition-colors shadow-sm" :class="osintModules.email ? 'bg-blue-900/40 border-blue-500/50 text-blue-400' : 'bg-black border-white/10 text-slate-600'">Correos/MX</button>
                                </div>
                            </div>
                        </div>

                        <div class="relative flex-1 min-h-[160px]">
                            <div class="absolute top-3 left-4 flex items-center gap-2 pointer-events-none z-10 font-mono text-red-500/80 text-xs font-black drop-shadow-[0_0_5px_red]">
                                <span>root@GHOST-SWARM:~/payload_injection#</span>
                                <span class="w-1.5 h-3.5 bg-red-500 animate-pulse block"></span>
                            </div>
                            
                            <textarea id="target-input"
                                   name="search_query" 
                                   @input="handleInput($event)"
                                   placeholder="&#10;&#10;> INYECTE AQUI LA LISTA DE OBJETIVOS (Soporta miles de líneas)&#10;> Automáticamente realizará peticiones DNS en vivo en el frontend.&#10;> Ej: Gimnasio Campestre, sanpatricio.edu.co, Liceo Francés"
                                   class="w-full h-full bg-[#030303] border border-red-900/30 rounded-lg text-emerald-400 px-4 pt-10 pb-4 focus:border-red-500 focus:ring-1 focus:ring-red-500/50 text-[15px] placeholder:text-red-900/20 font-medium resize-none font-mono leading-relaxed transition-all shadow-[inset_0_0_20px_rgba(0,0,0,1)] custom-scrollbar"
                                   autocomplete="off"
                                   spellcheck="false"
                                   required></textarea>
                            
                            <div class="absolute bottom-4 right-4 flex gap-2 pointer-events-none" x-show="targetCount > 0" x-transition>
                                <div class="bg-slate-900/80 border border-slate-500/50 px-2 py-1 rounded text-slate-300 font-mono text-[9px] tracking-widest backdrop-blur-md font-bold shadow-lg">
                                    LÍNEAS: <span x-text="targetCount" class="text-white"></span>
                                </div>
                                <div class="bg-blue-900/80 border border-blue-500/50 px-2 py-1 rounded text-blue-300 font-mono text-[9px] tracking-widest backdrop-blur-md font-bold shadow-[0_0_8px_rgba(59,130,246,0.3)]">
                                    URLs: <span x-text="metrics.urls" class="text-white"></span>
                                </div>
                                <div class="bg-yellow-900/80 border border-yellow-500/50 px-2 py-1 rounded text-yellow-300 font-mono text-[9px] tracking-widest backdrop-blur-md font-bold shadow-[0_0_8px_rgba(234,179,8,0.3)]">
                                    NOMBRES RAW: <span x-text="metrics.names" class="text-white"></span>
                                </div>
                            </div>
                        </div>

                        <div class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-0 transition-opacity z-10 pointer-events-none drop-shadow-[0_0_15px_red]"
                             :class="isScanning ? 'opacity-100 animate-scanner-down' : ''"></div>
                    </div>

                    <div class="w-full xl:w-[280px] bg-[#020202] border-t xl:border-t-0 xl:border-l border-red-900/40 p-4 flex flex-col justify-between relative">
                        
                        <div class="flex flex-col mb-4 font-mono">
                            <span class="text-[9px] text-slate-500 uppercase tracking-[0.3em] block mb-1">Carga a Inyectar</span>
                            <div class="flex justify-between items-end border-b border-white/5 pb-2">
                                <span class="text-4xl text-white font-black drop-shadow-[0_0_10px_rgba(255,255,255,0.2)] tracking-tighter leading-none" x-text="targetCount">0</span>
                                <span class="text-[9px] font-black px-1.5 py-0.5 rounded border mb-1" 
                                      :class="targetCount > 10 ? 'bg-red-900/40 text-red-400 border-red-500/50' : 'bg-blue-900/40 text-blue-400 border-blue-500/50'"
                                      x-text="targetCount > 10 ? 'SWARM MODE' : 'SNIPER MODE'"></span>
                            </div>
                        </div>

                        <div class="w-full bg-black border border-white/10 rounded-lg p-3 mb-4 transition-opacity duration-300" :class="isScanning ? 'opacity-100' : 'opacity-0 pointer-events-none'">
                            <span class="text-[8px] font-mono text-red-400 uppercase tracking-widest block mb-1.5 flex justify-between">
                                <span>Operación Activa</span>
                                <span x-text="scanProgress + '%'"></span>
                            </span>
                            <div class="w-full bg-slate-900 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-red-500 h-full transition-all duration-[2000ms] shadow-[0_0_8px_red]" :style="'width: ' + scanProgress + '%'"></div>
                            </div>
                            <span class="text-[7px] font-mono text-slate-500 uppercase tracking-widest block mt-1.5 text-center truncate" x-text="scanStatus"></span>
                        </div>

                        <div class="space-y-3 mt-auto">
                            <button type="button" @click="clearSystem()" :disabled="isScanning"
                                    class="w-full py-2.5 bg-transparent hover:bg-white/5 text-slate-400 text-[10px] font-mono font-bold uppercase tracking-[0.4em] rounded-lg border border-white/10 transition-colors disabled:opacity-30">
                                Limpiar Payload
                            </button>
                            
                            <button type="button" 
                                    x-show="isScanning"
                                    @click="abortMission()"
                                    class="w-full py-4 font-black text-xs tracking-[0.2em] uppercase rounded-xl border transition-all flex items-center justify-center gap-2 bg-red-950 text-red-400 border-red-500/80 shadow-[0_0_20px_rgba(220,38,38,0.4)] hover:bg-red-900 hover:text-white hover:border-red-400 animate-pulse">
                                <span class="material-symbols-outlined text-lg">cancel</span>
                                ABORTAR MISIÓN
                            </button>

                            <button type="submit" 
                                    x-show="!isScanning"
                                    :disabled="targetCount === 0"
                                    class="w-full py-4 font-black text-xs md:text-sm tracking-[0.2em] uppercase rounded-xl border shadow-[0_0_20px_rgba(0,0,0,0.5)] transition-all flex items-center justify-center gap-2 group relative overflow-hidden"
                                    :class="isComplete ? 'bg-gradient-to-r from-emerald-800 to-emerald-600 text-white border-emerald-400/50 hover:shadow-[0_0_30px_rgba(16,185,129,0.5)]' : 'bg-gradient-to-r from-red-800 to-red-600 text-white border-red-400/50 hover:shadow-[0_0_30px_rgba(220,38,38,0.7)] disabled:opacity-30 disabled:cursor-not-allowed'">
                                <div class="absolute inset-0 bg-[linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent)] -translate-x-full group-hover:animate-shine"></div>
                                <span class="material-symbols-outlined text-xl drop-shadow-[0_0_5px_white]"
                                      :class="isComplete ? '' : 'group-hover:rotate-90 transition-transform duration-500'" 
                                      x-text="isComplete ? 'published_with_changes' : 'crisis_alert'"></span>
                                <span x-text="isComplete ? 'NUEVA BÚSQUEDA' : 'INICIAR EXTRACCIÓN'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </section>

            <div class="mt-2 flex flex-col h-full overflow-hidden">
                
                <h3 class="text-emerald-500 font-mono text-[10px] font-black uppercase tracking-[0.5em] mb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[14px]">table_chart</span> 
                    Paso 2: Base de Datos & Resultados de Inteligencia
                </h3>

                <div id="sniper-display" class="flex-1 transition-all duration-500 relative bg-[#010101] border rounded-xl shadow-[inset_0_0_50px_rgba(0,0,0,1)] overflow-y-auto custom-scrollbar cyber-panel min-h-[400px]"
                     :class="isComplete ? 'border-emerald-500/30' : 'border-red-900/30'">
                    
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-8 z-0 pointer-events-none">
                        
                        <div class="relative w-[320px] h-[320px] mb-8 mix-blend-screen opacity-50 transition-opacity duration-500" :class="isScanning ? 'opacity-90' : ''">
                            <div class="absolute inset-0 rounded-full border border-red-900/30"></div>
                            <div class="absolute inset-[15%] rounded-full border border-red-900/20 border-dashed animate-[spin_20s_linear_infinite_reverse]"></div>
                            <div class="absolute inset-[30%] rounded-full border border-red-900/10"></div>
                            <div class="absolute inset-[45%] rounded-full border-2 border-red-900/20 border-dotted animate-[spin_15s_linear_infinite]"></div>
                            <div class="absolute top-1/2 left-0 w-full h-[1px] bg-red-900/40"></div>
                            <div class="absolute top-0 left-1/2 w-[1px] h-full bg-red-900/40"></div>
                            <div class="absolute inset-0 rounded-full overflow-hidden bg-[conic-gradient(transparent_250deg,rgba(220,38,38,0.7)_360deg)] origin-center"
                                 :class="isScanning ? 'animate-[spin_1.5s_linear_infinite]' : 'animate-[spin_4s_linear_infinite]'"></div>
                            
                            <template x-if="isScanning">
                                <div>
                                    <div class="absolute top-[20%] left-[30%] w-2 h-2 bg-emerald-500 rounded-full shadow-[0_0_15px_emerald] animate-pulse"></div>
                                    <div class="absolute bottom-[25%] right-[35%] w-1.5 h-1.5 bg-blue-500 rounded-full shadow-[0_0_10px_blue] animate-ping delay-150"></div>
                                    <div class="absolute top-[60%] left-[75%] w-2 h-2 bg-red-500 rounded-full shadow-[0_0_10px_red] animate-pulse delay-300"></div>
                                </div>
                            </template>
                            
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-black border border-red-500 rounded-full flex items-center justify-center shadow-[0_0_20px_red]">
                                <div class="w-1.5 h-1.5 bg-white rounded-full" :class="isScanning ? 'animate-ping' : ''"></div>
                            </div>
                        </div>

                        <div class="text-center relative z-10 bg-black/80 p-6 border backdrop-blur-md rounded-xl shadow-2xl max-w-xl transition-colors duration-500"
                             :class="isScanning ? 'border-red-500/50' : 'border-red-900/40'">
                            <h3 class="font-mono text-base uppercase tracking-[0.4em] mb-3 font-black flex justify-center items-center gap-2"
                                :class="isScanning ? 'text-red-500 drop-shadow-[0_0_8px_red]' : 'text-slate-500'">
                                <span class="material-symbols-outlined text-2xl" :class="isScanning ? 'animate-[spin_1s_linear_infinite]' : ''">track_changes</span>
                                <span x-text="isScanning ? 'INYECTANDO DATOS AL BACKEND DJANGO...' : 'SISTEMA EN ESPERA'"></span>
                            </h3>
                            <p class="text-slate-400 text-xs leading-relaxed font-mono tracking-wider">
                                <span x-show="!isScanning">Añada contexto (Ciudad/País) para extrema precisión. Active o desactive los vectores OSINT y presione Iniciar. El servidor de Python ejecutará la búsqueda en la web y los resultados se renderizarán aquí.</span>
                                <span x-show="isScanning" class="text-red-300">Por favor espere. Django está ejecutando Celery/BeautifulSoup en segundo plano para raspar internet, evadir firewalls y extraer la información directamente a PostgreSQL.</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CAPTURA ESTRICTA DE ERRORES DE BACKEND
        document.body.addEventListener('htmx:responseError', function(evt) {
            const alpine = document.querySelector('[x-data]').__x.$data;
            alpine.stopScanSimulation();
            alpine.addLog(`!!! [FATAL] EL SERVIDOR DEVOLVIÓ ERROR ${evt.detail.xhr.status}`, "text-red-500 font-black bg-white/10 p-1");
            alpine.addLog("!!! ESTO SIGNIFICA QUE TU ARCHIVO views.py ESTÁ FALLANDO.", "text-red-400 font-bold");
            
            // Inyecta el error visual en el div para que no te quedes ciego
            document.getElementById('sniper-display').innerHTML = `
                <div class="p-8">
                    <div class="bg-red-950/50 border-2 border-red-500 p-6 rounded-lg font-mono text-red-200">
                        <h2 class="text-2xl font-black text-red-500 flex items-center gap-2 mb-4"><span class="material-symbols-outlined">warning</span> ERROR EN EL BACKEND (PYTHON)</h2>
                        <p class="mb-4">El Frontend envió los datos correctamente, pero <strong>Django (views.py)</strong> falló al procesarlos. Revisa la terminal de tu servidor (donde corres <code>runserver</code>) para ver el Traceback de Python.</p>
                        <p><strong>Código HTTP:</strong> ${evt.detail.xhr.status}</p>
                    </div>
                </div>
            `;
        });

        // MANEJO DE INICIO Y LOGS EN VIVO
        document.body.addEventListener('htmx:beforeRequest', (event) => {
            if(event.detail.target.id === 'sniper-display') {
                const alpine = document.querySelector('[x-data]').__x.$data;
                alpine.startScanSimulation();
            }
        });
        
        // MANEJO DE ÉXITO
        document.body.addEventListener('htmx:afterSwap', (event) => {
            if(event.detail.target.id === 'sniper-display') {
                const alpine = document.querySelector('[x-data]').__x.$data;
                alpine.stopScanSimulation();
                alpine.isComplete = true;
                alpine.addLog("<<< [HTTP 200 OK] CARGA ÚTIL RECIBIDA DESDE EL SERVIDOR.", "text-emerald-500 font-black");
                alpine.addLog("<<< [DB_SYNC] EXTRACCIÓN GUARDADA EN POSTGRESQL EXITOSAMENTE.", "text-emerald-400");
            }
        });

        // ==========================================
        // ALPINE.JS MOTOR CLIENT-SIDE (GOD TIER)
        // ==========================================
        function ghostSwarmTerminal() {
            return {
                isScanning: false,
                isComplete: false,
                targetCount: 0,
                sysTime: '',
                scanProgress: 0,
                scanStatus: 'INICIANDO ENLACE SECURE...',
                metrics: { uplink: 32, nodes: 120, proxies: 489, urls: 0, names: 0, dns_queries: 0 },
                logs: [],
                osintModules: { lms: true, whatsapp: true, email: true },
                simInterval: null,
                resolvedDomains: new Set(),
                
                initializeSystem() {
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);
                    
                    setInterval(() => {
                        if(!this.isScanning) {
                            this.metrics.uplink = Math.floor(Math.random() * (45 - 20 + 1) + 20);
                        } else {
                            this.metrics.uplink = Math.floor(Math.random() * (250 - 150 + 1) + 150);
                        }
                    }, 1500);

                    setTimeout(() => this.addLog("SYSTEM BOOT: GHOST SWARM V11.0 [LEVIATHAN CLASS]", "text-white font-black"), 300);
                    setTimeout(() => this.addLog("ENCRYPTION: AES-256 GCM [VERIFIED]", "text-emerald-400"), 600);
                    setTimeout(() => this.addLog("API HOOKS: HTMX READY | CLOUDFLARE DNS READY", "text-blue-400"), 900);
                    setTimeout(() => this.addLog("AWAITING TARGET COORDINATES...", "text-slate-400"), 1200);
                },

                updateTime() {
                    const now = new Date();
                    this.sysTime = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
                },

                // LÓGICA DE PARSEO Y PRE-RECONOCIMIENTO DNS (FRONTEND MAGIC)
                async handleInput(e) {
                    const text = e.target.value;
                    if (!text.trim()) {
                        this.targetCount = this.metrics.urls = this.metrics.names = 0;
                        this.isComplete = false;
                        return;
                    }
                    
                    const rawTargets = text.split(/[\n,;]+/).map(t => t.trim()).filter(t => t.length > 3);
                    const uniqueTargets = [...new Set(rawTargets)];
                    this.targetCount = uniqueTargets.length;
                    
                    const urlRegex = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/i;
                    
                    const newUrls = uniqueTargets.filter(t => urlRegex.test(t));
                    this.metrics.urls = newUrls.length;
                    this.metrics.names = this.targetCount - this.metrics.urls;
                    
                    // PRE-RECONOCIMIENTO EN VIVO: Si el usuario teclea un dominio, consultamos a Cloudflare DNS gratis!
                    for (let domain of newUrls) {
                        // Limpiamos dominio
                        let cleanDomain = domain.replace(/^https?:\/\//, '').split('/')[0];
                        if (!this.resolvedDomains.has(cleanDomain)) {
                            this.resolvedDomains.add(cleanDomain);
                            this.metrics.dns_queries++;
                            this.addLog(`>>> [DNS_QUERY] RESOLVIENDO IP PARA: ${cleanDomain}...`, "text-slate-400");
                            
                            try {
                                // Petición real al servidor de Cloudflare
                                let res = await fetch(`https://cloudflare-dns.com/dns-query?name=${cleanDomain}&type=A`, {
                                    headers: { 'Accept': 'application/dns-json' }
                                });
                                let data = await res.json();
                                if(data.Status === 0 && data.Answer) {
                                    let ip = data.Answer[0].data;
                                    this.addLog(`<<< [DNS_HIT] ${cleanDomain} -> <span class="text-white bg-blue-900 px-1 rounded">${ip}</span>`, "text-blue-400 font-bold");
                                }
                            } catch (err) {
                                // Ignoramos fallos silently en frontend
                            }
                        }
                    }
                },

                clearSystem() {
                    document.getElementById('swarm-input-form').reset();
                    document.getElementById('sniper-display').innerHTML = ''; 
                    this.targetCount = this.metrics.urls = this.metrics.names = this.metrics.dns_queries = 0;
                    this.isScanning = this.isComplete = false;
                    this.scanProgress = 0;
                    this.resolvedDomains.clear();
                    this.addLog("[SYS_COMMAND] MEMORIA PURGADA POR EL OPERADOR.", "text-yellow-500 font-bold");
                },

                executeAnalysis(e) {
                    if(this.targetCount === 0 || this.isScanning) {
                        e.preventDefault();
                        return false;
                    }
                    this.isComplete = false;
                },

                abortMission() {
                    this.addLog("!!! ENVIANDO SEÑAL DE ABORTO AL NÚCLEO HTMX...", "text-red-500 font-black");
                    htmx.trigger('#swarm-input-form', 'htmx:abort');
                },

                startScanSimulation() {
                    this.isScanning = true;
                    this.scanProgress = 0;
                    this.addLog("========================================", "text-slate-600");
                    this.addLog(">>> [HTTP POST] ENVIANDO BATCH A DJANGO BACKEND...", "text-purple-400 font-bold");
                    
                    const stages = [
                        { p: 15, m: "ESPERANDO CONFIRMACIÓN DEL WORKER CELERY...", c: "text-slate-400" },
                        { p: 30, m: "EJECUTANDO GOOGLE DORKS PARA RESOLUCIÓN URL...", c: "text-yellow-400" },
                        { p: 45, m: "BYPASS CLOUDFLARE E INICIANDO SCRAPER BS4...", c: "text-red-400" },
                        { p: 65, m: "RASTREANDO CÓDIGO FUENTE (LMS, EMAILS, WA)...", c: "text-blue-400" },
                        { p: 85, m: "LLAMANDO A LA API DE DEEPSEEK IA PARA LIMPIEZA...", c: "text-emerald-400" },
                        { p: 95, m: "GUARDANDO ESTRUCTURA EN POSTGRESQL DB...", c: "text-purple-400 font-bold" }
                    ];

                    let step = 0;
                    this.simInterval = setInterval(() => {
                        if (step < stages.length) {
                            this.scanProgress = stages[step].p;
                            this.scanStatus = stages[step].m;
                            this.addLog(`>>> [BACKEND] ${stages[step].m}`, stages[step].c);
                            step++;
                        } else {
                            this.scanProgress = 99;
                            this.scanStatus = "ESPERANDO RESPUESTA FINAL DE LA VISTA DJANGO...";
                        }
                    }, 2500);
                },

                stopScanSimulation() {
                    this.isScanning = false;
                    this.scanProgress = 100;
                    clearInterval(this.simInterval);
                },

                addLog(msg, colorClass = "text-red-500") {
                    const time = new Date().toISOString().substring(11, 19);
                    const htmlLog = `<span class="text-slate-600 font-bold">[${time}]</span> <span class="${colorClass}">${msg}</span>`;
                    this.logs.unshift(htmlLog);
                    if(this.logs.length > 50) this.logs.pop(); // Guarda hasta 50 logs 
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700;900&display=swap');
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar Ultra-Delgada */
        .custom-scrollbar::-webkit-scrollbar, ::-webkit-scrollbar { width: 5px; height: 5px; background: transparent; }
        ::-webkit-scrollbar-thumb { background: #450a0a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #dc2626; }
        ::-webkit-scrollbar-corner { background: transparent; }

        /* Comportamiento Vital de HTMX */
        .htmx-indicator { opacity: 0; pointer-events: none; transition: opacity 300ms ease-in-out; display: flex !important; visibility: hidden; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { opacity: 1; pointer-events: all; visibility: visible; }

        /* Formas Geométricas CSS */
        .hexagon-clip { clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
        .cyber-clip { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%); }
        .panel-clip { clip-path: polygon(0 0, calc(100% - 25px) 0, 100% 25px, 100% 100%, 0 100%); }

        /* Animaciones Core */
        @keyframes scanline-h { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes scanline-v { 0% { top: 0; } 100% { top: 100%; } }
        @keyframes scanner-down { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes shine { 100% { transform: translateX(100%); } }
        
        .animate-scanline-h { animation: scanline-h 4s linear infinite; }
        .animate-scanline-v { animation: scanline-v 2.5s linear infinite; }
        .animate-scanner-down { animation: scanner-down 2s ease-in-out infinite; }
        .animate-shine { animation: shine 2s ease-in-out infinite; }

        /* Texto Glitch (Puro CSS God Tier) */
        .glitch { position: relative; }
        .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; }
        .glitch::before { left: 3px; text-shadow: -2px 0 red; clip: rect(24px, 550px, 90px, 0); animation: glitch-anim-2 3s infinite linear alternate-reverse; }
        .glitch::after { left: -3px; text-shadow: -2px 0 blue; clip: rect(85px, 550px, 140px, 0); animation: glitch-anim 2.5s infinite linear alternate-reverse; }
        
        @keyframes glitch-anim { 0% { clip: rect(18px, 9999px, 86px, 0); } 20% { clip: rect(65px, 9999px, 11px, 0); } 40% { clip: rect(113px, 9999px, 10px, 0); } 60% { clip: rect(12px, 9999px, 76px, 0); } 80% { clip: rect(54px, 9999px, 86px, 0); } 100% { clip: rect(104px, 9999px, 120px, 0); } }
        @keyframes glitch-anim-2 { 0% { clip: rect(65px, 9999px, 100px, 0); } 20% { clip: rect(12px, 9999px, 65px, 0); } 40% { clip: rect(88px, 9999px, 12px, 0); } 60% { clip: rect(14px, 9999px, 94px, 0); } 80% { clip: rect(44px, 9999px, 55px, 0); } 100% { clip: rect(98px, 9999px, 14px, 0); } }

        .glitch-text { animation: glitch-skew 1s infinite linear alternate-reverse; }
        @keyframes glitch-skew { 0% { transform: skew(0deg); } 90% { transform: skew(0deg); } 95% { transform: skew(-5deg); } 100% { transform: skew(5deg); } }
    </style>
</main>
{% endblock %}