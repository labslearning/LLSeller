version: '3.8'

# =========================================================
# CL칔STER DE PRODUCCI칍N TIER GOD (SILICON VALLEY / TEL AVIV)
# FIREWALL BYPASS - MODO HOST NATIVO (PARA PARROT OS / KALI)
# =========================================================

x-common-env: &common-env
  # [FIREWALL BYPASS]: Destruimos los DNS virtuales. Todo el tr치fico viaja por el localhost del kernel.
  # 游댠 CAMBIO 1: La URL de la DB ahora apunta al puerto 5454
  DATABASE_URL: postgres://sovereign_db_user:9967112fhr@127.0.0.1:5454/sovereign_db
  CELERY_BROKER_URL: redis://127.0.0.1:6379/0
  CELERY_RESULT_BACKEND: redis://127.0.0.1:6379/0
  POSTGRES_HOST: 127.0.0.1
  REDIS_HOST: 127.0.0.1
  TZ: "America/Bogota"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-security: &default-security
  security_opt:
    - no-new-privileges:true
  init: true

services:
  # ==========================================
  # 1. THE VAULT (PostgreSQL Database)
  # ==========================================
  db:
    image: postgres:15-alpine
    container_name: sovereign_db
    restart: always
    # 游댠 [MAGIA AQU칈]: Salto de Firewall
    network_mode: "host"
    <<: *default-security
    # 游댠 CAMBIO 2: [EVASI칍N DE PARROT OS] Obligamos al motor a usar el puerto 5454
    command: postgres -p 5454
    volumes:
      - postgres_data:/var/lib/postgresql/data:Z
    environment:
      POSTGRES_USER: sovereign_db_user
      POSTGRES_PASSWORD: 9967112fhr
      POSTGRES_DB: sovereign_db
    logging: *default-logging
    healthcheck:
      # 游댠 CAMBIO 3: El scanner ahora busca en el puerto 5454
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5454 -U sovereign_db_user -d sovereign_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ==========================================
  # 2. NEURAL MEMORY (Redis Broker)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: sovereign_redis
    restart: always
    network_mode: "host"
    <<: *default-security
    volumes:
      - redis_data:/data:Z
    # [FIX GOD TIER]: Forzamos expl칤citamente el bind a IPv4 (127.0.0.1) para evitar que Podman lo mande a IPv6
    command: redis-server --bind 127.0.0.1 --save 60 1 --loglevel warning --appendonly yes
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 ping | grep PONG || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================
  # 3. COMMAND CENTER (Django + Gunicorn)
  # ==========================================
  web:
    build: .
    container_name: sovereign_web
    restart: always
    network_mode: "host"
    <<: *default-security
    # Gunicorn expuesto a 0.0.0.0 para que puedas acceder desde fuera
    command: gunicorn core.asgi:application -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --workers 3 --threads 2
    volumes:
      - static_volume:/app/staticfiles:Z
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: full
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --server-response http://127.0.0.1:8000/admin/login/ 2>&1 | grep -q 'HTTP/1.1 200\\|HTTP/1.1 302' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    # Eliminados los depends_on problem치ticos en Podman host mode

  # ==========================================
  # 4. GHOST SNIPER FLEET (Celery Workers)
  # ==========================================
  celery_worker:
    build: .
    container_name: sovereign_celery_worker
    restart: always
    network_mode: "host"
    <<: *default-security
    shm_size: '2gb' 
    # [FIX GOD TIER]: A침adido -E para eventos (vital para Flower), -b para el broker expl칤cito y sintonizaci칩n de colas (-Q)
    command: celery -A core worker -l info -E -b redis://127.0.0.1:6379/0 -Q discovery_queue,scraping_queue,default,celery --concurrency=4 --prefetch-multiplier=1 --max-tasks-per-child=50
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: none
    logging: *default-logging
    # Eliminados los depends_on problem치ticos en Podman host mode

  # ==========================================
  # 5. THE MASTER CLOCK (Celery Beat)
  # ==========================================
  celery_beat:
    build: .
    container_name: sovereign_celery_beat
    restart: always
    network_mode: "host"
    <<: *default-security
    command: celery -A core beat -l info --pidfile=
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: none
    logging: *default-logging
    # Eliminados los depends_on problem치ticos en Podman host mode

  # ==========================================
  # 6. OVERSEER (Celery Flower - Visual Monitor)
  # ==========================================
  celery_flower:
    build: .
    container_name: sovereign_flower
    restart: always
    network_mode: "host"
    <<: *default-security
    command:
      - celery
      - -A
      - core
      - flower
      - --port=5555
      - --address=0.0.0.0
      - --broker=redis://127.0.0.1:6379/0
      - --basic_auth=admin:SovereignAdmin2026!
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider --http-user=admin --http-password='SovereignAdmin2026!' http://127.0.0.1:5555/ || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 25s
    # Eliminados los depends_on problem치ticos en Podman host mode

volumes:
  postgres_data:
  redis_data:
  static_volume: