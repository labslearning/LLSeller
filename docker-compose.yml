version: '3.8'

# =========================================================
# CL√öSTER DE PRODUCCI√ìN TIER GOD (SILICON VALLEY / TEL AVIV)
# FIREWALL BYPASS - MODO HOST NATIVO (PARA PARROT OS / KALI)
# =========================================================

x-common-env: &common-env
  # [FIREWALL BYPASS]: Destruimos los DNS virtuales. Todo el tr√°fico viaja por el localhost del kernel.
  DATABASE_URL: postgres://sovereign_db_user:SovereignGodTier2026!@127.0.0.1:5432/sovereign_db
  CELERY_BROKER_URL: redis://127.0.0.1:6379/0
  CELERY_RESULT_BACKEND: redis://127.0.0.1:6379/0
  POSTGRES_HOST: 127.0.0.1
  REDIS_HOST: 127.0.0.1
  TZ: "America/Bogota"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-security: &default-security
  security_opt:
    - no-new-privileges:true
  init: true

services:
  # ==========================================
  # 1. THE VAULT (PostgreSQL Database)
  # ==========================================
  db:
    image: postgres:15-alpine
    container_name: sovereign_db
    restart: always
    # üî• [MAGIA AQU√ç]: Salto de Firewall
    network_mode: "host"
    <<: *default-security
    volumes:
      - postgres_data:/var/lib/postgresql/data:Z
    environment:
      POSTGRES_USER: sovereign_db_user
      POSTGRES_PASSWORD: SovereignGodTier2026!
      POSTGRES_DB: sovereign_db
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -U sovereign_db_user -d sovereign_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ==========================================
  # 2. NEURAL MEMORY (Redis Broker)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: sovereign_redis
    restart: always
    network_mode: "host"
    <<: *default-security
    volumes:
      - redis_data:/data:Z
    command: redis-server --save 60 1 --loglevel warning --appendonly yes
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 ping | grep PONG || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================
  # 3. COMMAND CENTER (Django + Gunicorn)
  # ==========================================
  web:
    build: .
    container_name: sovereign_web
    restart: always
    network_mode: "host"
    <<: *default-security
    # Gunicorn expuesto a 0.0.0.0 para que puedas acceder desde fuera
    command: gunicorn core.asgi:application -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --workers 3 --threads 2
    volumes:
      - static_volume:/app/staticfiles:Z
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: full
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --server-response http://127.0.0.1:8000/admin/login/ 2>&1 | grep -q 'HTTP/1.1 200\\|HTTP/1.1 302' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==========================================
  # 4. GHOST SNIPER FLEET (Celery Workers)
  # ==========================================
  celery_worker:
    build: .
    container_name: sovereign_celery_worker
    restart: always
    network_mode: "host"
    <<: *default-security
    shm_size: '2gb' 
    command: celery -A core worker -l info --concurrency=4 --prefetch-multiplier=1 --max-tasks-per-child=50
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: none
    logging: *default-logging
    depends_on:
      web:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==========================================
  # 5. THE MASTER CLOCK (Celery Beat)
  # ==========================================
  celery_beat:
    build: .
    container_name: sovereign_celery_beat
    restart: always
    network_mode: "host"
    <<: *default-security
    command: celery -A core beat -l info --pidfile=
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: none
    logging: *default-logging
    depends_on:
      web:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==========================================
  # 6. OVERSEER (Celery Flower - Visual Monitor)
  # ==========================================
  celery_flower:
    build: .
    container_name: sovereign_flower
    restart: always
    network_mode: "host"
    <<: *default-security
    command:
      - celery
      - -A
      - core
      - flower
      - --port=5555
      - --address=0.0.0.0
      - --broker=redis://127.0.0.1:6379/0
      - --basic_auth=admin:SovereignAdmin2026!
    env_file:
      - .env
    environment:
      <<: *common-env
      BOOTSTRAP_MODE: none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider --http-user=admin --http-password='SovereignAdmin2026!' http://127.0.0.1:5555/ || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 25s
    depends_on:
      web:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  static_volume: