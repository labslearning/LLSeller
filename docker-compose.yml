version: '3.8'

# =========================================================
# CLÚSTER DE PRODUCCIÓN TIER GOD (SILICON VALLEY / TEL AVIV)
# =========================================================

# --- PLANTILLAS REUTILIZABLES (DRY PRINCIPLE) ---
x-common-env: &common-env
  DATABASE_URL: postgres://sovereign_db_user:SovereignGodTier2026!@db:5432/sovereign_db
  CELERY_BROKER_URL: redis://redis:6379/0
  CELERY_RESULT_BACKEND: redis://redis:6379/0
  TZ: "America/Bogota" # Sincroniza el tiempo de los ataques

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-security: &default-security
  # Bloquea ataques de escalada de privilegios a nivel del Kernel de Linux
  security_opt:
    - no-new-privileges:true
  init: true # Evita procesos Zombies (Complementa a Tini)

networks:
  sovereign_net:
    driver: bridge

services:
  # ==========================================
  # 1. THE VAULT (PostgreSQL Database)
  # ==========================================
  db:
    image: postgres:15-alpine
    container_name: sovereign_db
    restart: always
    <<: *default-security
    networks:
      - sovereign_net
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432" # <--- [PUENTE ACTIVO]: Permite que tu venv local se conecte al Vault
    environment:
      POSTGRES_USER: sovereign_db_user
      POSTGRES_PASSWORD: SovereignGodTier2026!
      POSTGRES_DB: sovereign_db
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sovereign_db_user -d sovereign_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s # Da tiempo al Vault para crear los archivos la primera vez
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # ==========================================
  # 2. NEURAL MEMORY (Redis Broker)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: sovereign_redis
    restart: always
    <<: *default-security
    networks:
      - sovereign_net
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379" # <--- [PUENTE ACTIVO]: Permite que tu Celery/venv local vea el Broker
    command: redis-server --save 60 1 --loglevel warning --appendonly yes
    logging: *default-logging
    healthcheck:
      # [FIX GOD TIER]: Usamos el comando nativo de Redis para el chequeo de salud
      test: ["CMD-SHELL", "redis-cli ping | grep PONG || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ==========================================
  # 3. COMMAND CENTER (Django + Gunicorn)
  # ==========================================
  web:
    build: .
    container_name: sovereign_web
    restart: always
    <<: *default-security
    networks:
      - sovereign_net
    command: gunicorn core.asgi:application -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --workers 3 --threads 2
    volumes:
      - static_volume:/app/staticfiles
    ports:
      - "8080:8000"
    env_file:
      - .env
    environment:
      <<: *common-env
    logging: *default-logging
    healthcheck:
      # [FIX GOD TIER]: Usamos wget porque la imagen mínima (slim) no tiene curl
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==========================================
  # 4. GHOST SNIPER FLEET (Celery Workers)
  # ==========================================
  celery_worker:
    build: .
    container_name: sovereign_celery_worker
    restart: always
    <<: *default-security
    # [CRÍTICO]: Chrome requiere más de 64MB de /dev/shm para no crashear
    shm_size: '2gb' 
    networks:
      - sovereign_net
    command: celery -A core worker -l info --concurrency=4 --prefetch-multiplier=1 --max-tasks-per-child=50
    env_file:
      - .env
    environment:
      <<: *common-env
    logging: *default-logging
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G

  # ==========================================
  # 5. THE MASTER CLOCK (Celery Beat)
  # ==========================================
  celery_beat:
    build: .
    container_name: sovereign_celery_beat
    restart: always
    <<: *default-security
    networks:
      - sovereign_net
    command: celery -A core beat -l info --pidfile=
    env_file:
      - .env
    environment:
      <<: *common-env
    logging: *default-logging
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==========================================
  # 6. OVERSEER (Celery Flower - Visual Monitor)
  # ==========================================
  celery_flower:
    build: .
    container_name: sovereign_flower
    restart: always
    <<: *default-security
    networks:
      - sovereign_net
    # Forzamos conexión directa al broker interno para evitar el Connection Refused
    command: celery -A core flower --port=5555 --address=0.0.0.0 --broker=redis://redis:6379/0 --basic_auth=admin:SovereignAdmin2026!
    ports:
      - "5555:5555"
    env_file:
      - .env
    environment:
      <<: *common-env
    logging: *default-logging
    depends_on:
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  static_volume: